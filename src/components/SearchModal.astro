---
/**
 * SearchModal - ⌘K / Ctrl+K Search Modal
 * Professional search UI with animations and enhanced UX
 * Uses Pagefind for static search (must build first to index content)
 */
import { getI18nConfig, getTranslations, getLocaleFromPath } from '../utils/i18n';

const base = import.meta.env.BASE_URL.replace(/\/$/, "");
const currentPath = Astro.url.pathname;

// Get i18n translations
const i18nConfig = await getI18nConfig();
const translations = await getTranslations();
const currentLocale = getLocaleFromPath(currentPath, i18nConfig.locales) || i18nConfig.defaultLocale;
const t = translations[currentLocale] || translations.en || {};

// Translation strings
const searchPlaceholder = t['search.placeholder'] || 'Search documentation...';
const searchTitle = t['search.title'] || 'Search the documentation';
const searchHint = t['search.hint'] || 'Start typing to find what you\'re looking for';
const searchNoResults = t['search.noResults'] || 'No results found';
const searchNoResultsHint = t['search.noResultsHint'] || 'Try different keywords or check your spelling';
const searchUnavailable = t['search.unavailable'] || 'Search unavailable';
const searchBuildHint = t['search.buildHint'] || 'Run build to generate the search index';
const navNavigate = t['search.navigate'] || 'Navigate';
const navSelect = t['search.select'] || 'Select';
const navClose = t['search.close'] || 'Close';
---

<div
  id="search-modal"
  class="search-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-title"
  data-search-placeholder={searchPlaceholder}
  data-search-title={searchTitle}
  data-search-hint={searchHint}
  data-search-no-results={searchNoResults}
  data-search-no-results-hint={searchNoResultsHint}
  data-search-unavailable={searchUnavailable}
  data-search-build-hint={searchBuildHint}
>
  <div class="search-backdrop"></div>
  <div class="search-container">
    <!-- Header with search input -->
    <div class="search-header">
      <div class="search-input-wrapper">
        <div class="search-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
        </div>
        <input
          id="search-input"
          type="search"
          placeholder={searchPlaceholder}
          class="search-input"
          autocomplete="off"
          spellcheck="false"
        />
        <div class="search-loading" id="search-loading">
          <div class="search-spinner"></div>
        </div>
        <kbd class="search-kbd-esc">ESC</kbd>
      </div>
    </div>

    <!-- Results area -->
    <div id="search-results" class="search-results">
      <div class="search-empty">
        <div class="search-empty-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
        </div>
        <p class="search-empty-text">{searchTitle}</p>
        <p class="search-empty-hint">{searchHint}</p>
      </div>
    </div>

    <!-- Footer with keyboard hints -->
    <div class="search-footer">
      <div class="search-hints">
        <div class="search-hint">
          <kbd>↑</kbd><kbd>↓</kbd>
          <span>{navNavigate}</span>
        </div>
        <div class="search-hint">
          <kbd>↵</kbd>
          <span>{navSelect}</span>
        </div>
        <div class="search-hint">
          <kbd>ESC</kbd>
          <span>{navClose}</span>
        </div>
      </div>
      <div class="search-powered">
        <span>Powered by</span>
        <svg
          width="70"
          height="14"
          viewBox="0 0 70 14"
          fill="currentColor"
          class="pagefind-logo"
        >
          <text
            x="0"
            y="11"
            font-family="var(--font-sans)"
            font-size="11"
            font-weight="600">Pagefind</text
          >
        </svg>
      </div>
    </div>
  </div>
</div>

<style is:global>
  @reference "../styles/global.css";

  /* Modal overlay */
  .search-modal {
    @apply fixed inset-0 z-[100];
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 150ms ease,
      visibility 150ms ease;
  }

  .search-modal.open {
    @apply flex items-start justify-center;
    padding-top: 12vh;
    opacity: 1;
    visibility: visible;
  }

  /* Backdrop with blur */
  .search-backdrop {
    @apply absolute inset-0;
    background: oklch(from var(--background) l c h / 0.85);
    backdrop-filter: blur(8px) saturate(150%);
    -webkit-backdrop-filter: blur(8px) saturate(150%);
  }

  /* Main container */
  .search-container {
    @apply relative w-full max-w-2xl mx-4 rounded-xl overflow-hidden;
    @apply flex flex-col;
    max-height: 70vh;
    background: var(--card);
    border: 1px solid var(--border);
    box-shadow:
      0 0 0 1px oklch(from var(--primary-500) l c h / 0.1),
      0 16px 70px -12px rgb(0 0 0 / 0.35),
      0 8px 24px -8px rgb(0 0 0 / 0.2);
    transform: translateY(-10px) scale(0.98);
    opacity: 0;
    transition:
      transform 200ms cubic-bezier(0.32, 0.72, 0, 1),
      opacity 150ms ease;
  }

  .search-modal.open .search-container {
    transform: translateY(0) scale(1);
    opacity: 1;
  }

  /* Header */
  .search-header {
    @apply p-4;
    background: linear-gradient(
      to bottom,
      var(--card),
      oklch(from var(--muted) l c h / 0.3)
    );
    border-bottom: 1px solid var(--border);
  }

  .search-input-wrapper {
    @apply flex items-center gap-3;
  }

  .search-icon {
    @apply text-muted-foreground flex-shrink-0;
    transition: color 150ms ease;
  }

  .search-modal.open .search-input:focus ~ .search-icon,
  .search-input-wrapper:focus-within .search-icon {
    color: var(--primary-500);
  }

  .search-input {
    @apply flex-1 bg-transparent text-lg font-medium;
    @apply focus:outline-none;
    color: var(--foreground);
  }

  .search-input::placeholder {
    color: var(--muted-foreground);
    font-weight: 400;
  }

  /* Loading spinner */
  .search-loading {
    @apply hidden;
  }

  .search-loading.active {
    @apply block;
  }

  .search-spinner {
    @apply w-5 h-5 rounded-full;
    border: 2px solid var(--border);
    border-top-color: var(--primary-500);
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .search-kbd-esc {
    @apply px-2 py-1 text-xs font-mono rounded-md flex-shrink-0;
    background: var(--muted);
    color: var(--muted-foreground);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xs);
  }

  /* Results area */
  .search-results {
    @apply flex-1 overflow-y-auto;
    min-height: 200px;
    max-height: 400px;
  }

  /* Empty state */
  .search-empty {
    @apply flex flex-col items-center justify-center py-12 px-4;
  }

  .search-empty-icon {
    @apply text-muted-foreground/30 mb-4;
  }

  .search-empty-text {
    @apply text-base font-medium text-foreground mb-1;
  }

  .search-empty-hint {
    @apply text-sm text-muted-foreground;
  }

  /* No results state */
  .search-no-results {
    @apply flex flex-col items-center justify-center py-12 px-4 text-center;
  }

  .search-no-results-icon {
    @apply text-muted-foreground/30 mb-4;
  }

  .search-no-results-text {
    @apply text-base font-medium text-foreground mb-1;
  }

  .search-no-results-hint {
    @apply text-sm text-muted-foreground;
  }

  /* Results list */
  .search-results-list {
    @apply py-2;
  }

  .search-result-item {
    @apply flex items-center gap-3 mx-2 px-3 py-2.5 rounded-lg cursor-pointer;
    @apply transition-all duration-100 no-underline;
    text-decoration: none;
  }

  .search-result-item:hover {
    background: var(--muted);
  }

  .search-result-item.selected {
    background: var(--primary-500);
  }

  .search-result-icon {
    @apply flex-shrink-0 w-6 h-6 rounded flex items-center justify-center;
    color: var(--muted-foreground);
  }

  .search-result-item.selected .search-result-icon {
    color: var(--primary-foreground);
  }

  .search-result-content {
    @apply flex-1 min-w-0;
  }

  .search-result-title {
    @apply text-sm font-medium truncate;
    color: var(--foreground);
  }

  .search-result-item.selected .search-result-title {
    color: var(--primary-foreground);
  }

  .search-result-excerpt {
    @apply text-xs line-clamp-1 mt-0.5;
    color: var(--muted-foreground);
  }

  .search-result-item.selected .search-result-excerpt {
    color: oklch(from var(--primary-foreground) l c h / 0.8);
  }

  .search-result-excerpt :global(mark) {
    background: oklch(from var(--primary-400) l c h / 0.3);
    color: inherit;
    border-radius: 2px;
    padding: 0 2px;
  }

  .search-result-item.selected .search-result-excerpt :global(mark) {
    background: oklch(from var(--primary-foreground) l c h / 0.25);
    color: var(--primary-foreground);
  }

  .search-result-meta {
    @apply flex items-center gap-2 mt-0.5;
  }

  .search-result-path {
    @apply text-[11px] truncate;
    color: var(--muted-foreground);
    opacity: 0.7;
  }

  .search-result-item.selected .search-result-path {
    color: oklch(from var(--primary-foreground) l c h / 0.7);
  }

  .search-result-action {
    @apply flex-shrink-0 flex items-center gap-1 text-xs opacity-0;
    @apply transition-opacity duration-100;
    color: var(--muted-foreground);
  }

  .search-result-item.selected .search-result-action,
  .search-result-item:hover .search-result-action {
    opacity: 1;
  }

  .search-result-item.selected .search-result-action {
    color: var(--primary-foreground);
  }

  .search-result-action kbd {
    @apply inline-flex items-center justify-center px-1.5 h-5 text-[10px] font-mono rounded;
    background: oklch(from var(--background) l c h / 0.15);
    border: 1px solid oklch(from var(--border) l c h / 0.3);
  }

  .search-result-item.selected .search-result-action kbd {
    background: oklch(from var(--primary-foreground) l c h / 0.15);
    border-color: oklch(from var(--primary-foreground) l c h / 0.3);
  }

  /* Category/Section badge */
  .search-result-category {
    @apply text-[10px] font-medium uppercase tracking-wider px-1.5 py-0.5 rounded;
    background: var(--muted);
    color: var(--muted-foreground);
  }

  .search-result-item.selected .search-result-category {
    background: oklch(from var(--primary-foreground) l c h / 0.2);
    color: var(--primary-foreground);
  }

  /* Footer */
  .search-footer {
    @apply px-4 py-3 flex items-center justify-between;
    background: var(--muted);
    border-top: 1px solid var(--border);
  }

  .search-hints {
    @apply flex items-center gap-4;
  }

  .search-hint {
    @apply flex items-center gap-1.5 text-xs text-muted-foreground;
  }

  .search-hint kbd {
    @apply inline-flex items-center justify-center min-w-[20px] h-5 px-1.5;
    @apply text-[10px] font-mono rounded;
    background: var(--background);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-xs);
  }

  .search-powered {
    @apply flex items-center gap-2 text-xs text-muted-foreground;
  }

  .pagefind-logo {
    opacity: 0.6;
  }

  /* Section headers in results */
  .search-section-header {
    @apply px-4 py-2 text-xs font-semibold uppercase tracking-wider;
    color: var(--muted-foreground);
  }

  /* Scrollbar styling */
  .search-results::-webkit-scrollbar {
    width: 6px;
  }

  .search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  .search-results::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 3px;
  }

  .search-results::-webkit-scrollbar-thumb:hover {
    background: var(--muted-foreground);
  }
</style>

<script is:inline define:vars={{ base }}>
  let pagefind = null;
  let selectedIndex = 0;
  let results = [];
  let isLoading = false;
  let searchTimeout = null;

  async function initSearch() {
    const modal = document.getElementById("search-modal");
    const backdrop = modal?.querySelector(".search-backdrop");
    const input = document.getElementById("search-input");
    const resultsContainer = document.getElementById("search-results");
    const loadingEl = document.getElementById("search-loading");

    // Get translations from data attributes
    const searchTitle = modal?.dataset.searchTitle || 'Search the documentation';
    const searchHint = modal?.dataset.searchHint || 'Start typing to find what you\'re looking for';
    const searchNoResults = modal?.dataset.searchNoResults || 'No results found';
    const searchNoResultsHint = modal?.dataset.searchNoResultsHint || 'Try different keywords or check your spelling';
    const searchUnavailable = modal?.dataset.searchUnavailable || 'Search unavailable';
    const searchBuildHint = modal?.dataset.searchBuildHint || 'Run build to generate the search index';

    // Try to load Pagefind
    try {
      const pagefindPath = base + "/pagefind/pagefind.js";
      pagefind = await import(/* @vite-ignore */ pagefindPath);
      await pagefind.init();
    } catch (e) {
      console.log("Pagefind not available (run build first to generate index)");
    }

    function setLoading(loading) {
      isLoading = loading;
      if (loadingEl) {
        loadingEl.classList.toggle("active", loading);
      }
    }

    function openModal() {
      modal?.classList.add("open");
      document.body.style.overflow = "hidden";
      setTimeout(() => input?.focus(), 50);
    }

    function closeModal() {
      modal?.classList.remove("open");
      document.body.style.overflow = "";
      if (input) input.value = "";
      renderEmpty();
      results = [];
      selectedIndex = 0;
    }

    function renderEmpty() {
      if (!resultsContainer) return;
      resultsContainer.innerHTML = `
        <div class="search-empty">
          <div class="search-empty-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.3-4.3"/>
            </svg>
          </div>
          <p class="search-empty-text">${searchTitle}</p>
          <p class="search-empty-hint">${searchHint}</p>
        </div>
      `;
    }

    function renderNoResults(query) {
      if (!resultsContainer) return;
      resultsContainer.innerHTML = `
        <div class="search-no-results">
          <div class="search-no-results-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.3-4.3"/>
              <path d="M8 8l6 6M14 8l-6 6"/>
            </svg>
          </div>
          <p class="search-no-results-text">${searchNoResults} "${query}"</p>
          <p class="search-no-results-hint">${searchNoResultsHint}</p>
        </div>
      `;
    }

    function renderResults(searchResults) {
      if (!resultsContainer) return;

      if (searchResults.length === 0) {
        renderNoResults(input?.value || "");
        return;
      }

      const html = `
        <div class="search-results-list">
          ${searchResults
            .map((result, i) => {
              let url = result.url;
              if (base && !url.startsWith(base) && !url.startsWith("http")) {
                url = base + url;
              }
              const title =
                result.meta?.title ||
                url.split("/").pop()?.replace(/-/g, " ") ||
                "Untitled";
              const excerpt = result.excerpt || "";
              const pathParts = url
                .replace(base, "")
                .replace(/^\//, "")
                .replace(/\/$/, "")
                .split("/");
              const category =
                pathParts.length > 1 ? pathParts[0].replace(/-/g, " ") : "";

              return `
              <a href="${url}" class="search-result-item ${i === selectedIndex ? "selected" : ""}" data-index="${i}">
                <div class="search-result-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4"/>
                    <path d="M14 2v4a2 2 0 0 0 2 2h4"/>
                    <path d="m3 15 2 2 4-4"/>
                  </svg>
                </div>
                <div class="search-result-content">
                  <div class="search-result-title">${title}</div>
                  ${excerpt ? `<div class="search-result-excerpt">${excerpt}</div>` : ""}
                </div>
                ${category ? `<span class="search-result-category">${category}</span>` : ""}
                <div class="search-result-action">
                  <kbd>↵</kbd>
                </div>
              </a>
            `;
            })
            .join("")}
        </div>
      `;

      resultsContainer.innerHTML = html;

      // Add click handlers
      resultsContainer
        .querySelectorAll(".search-result-item")
        .forEach((item) => {
          item.addEventListener("click", () => closeModal());
        });
    }

    function updateSelection() {
      const items = resultsContainer?.querySelectorAll(".search-result-item");
      items?.forEach((item, i) => {
        item.classList.toggle("selected", i === selectedIndex);
      });

      // Scroll selected item into view
      const selectedItem = resultsContainer?.querySelector(
        ".search-result-item.selected",
      );
      selectedItem?.scrollIntoView({ block: "nearest", behavior: "smooth" });
    }

    // Keyboard shortcut: ⌘K or Ctrl+K
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        if (modal?.classList.contains("open")) {
          closeModal();
        } else {
          openModal();
        }
      }

      if (e.key === "Escape" && modal?.classList.contains("open")) {
        closeModal();
      }

      // Arrow navigation
      if (modal?.classList.contains("open") && results.length > 0) {
        if (e.key === "ArrowDown") {
          e.preventDefault();
          selectedIndex = (selectedIndex + 1) % results.length;
          updateSelection();
        }
        if (e.key === "ArrowUp") {
          e.preventDefault();
          selectedIndex = (selectedIndex - 1 + results.length) % results.length;
          updateSelection();
        }
        if (e.key === "Enter" && results[selectedIndex]) {
          e.preventDefault();
          let url = results[selectedIndex].url;
          if (base && !url.startsWith(base) && !url.startsWith("http")) {
            url = base + url;
          }
          window.location.href = url;
        }
      }
    });

    // Click backdrop to close
    backdrop?.addEventListener("click", closeModal);

    // Search as you type with debounce
    input?.addEventListener("input", async (e) => {
      const query = e.target.value.trim();

      // Clear previous timeout
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }

      if (!query) {
        renderEmpty();
        results = [];
        setLoading(false);
        return;
      }

      setLoading(true);

      // Debounce search
      searchTimeout = setTimeout(async () => {
        if (pagefind) {
          try {
            const search = await pagefind.search(query);
            results = await Promise.all(
              search.results.slice(0, 10).map((r) => r.data()),
            );
            selectedIndex = 0;
            renderResults(results);
          } catch (err) {
            console.error("Search error:", err);
            renderNoResults(query);
          }
        } else {
          // Fallback: no search available
          if (resultsContainer) {
            resultsContainer.innerHTML = `
              <div class="search-no-results">
                <div class="search-no-results-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 16v-4M12 8h.01"/>
                  </svg>
                </div>
                <p class="search-no-results-text">${searchUnavailable}</p>
                <p class="search-no-results-hint">${searchBuildHint}</p>
              </div>
            `;
          }
        }
        setLoading(false);
      }, 150);
    });

    // Expose open function for search trigger button
    window.openSearchModal = openModal;
  }

  initSearch();
  document.addEventListener("astro:page-load", initSearch);
</script>
